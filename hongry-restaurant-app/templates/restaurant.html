{% extends "master.html" %}
{% block content %}
<script id="clientTemplate" type="text/html">
    <div id="mi_${mid}" class="special_div">
	ID: <input id="mi_id_${mid}" class="texbox_normal" type="text"/> 
	<div style="float:right">Category: <input id="mi_p0_${mid}" class="texbox_normal" type="text"/> Subcategory: <input id="mi_p1_${mid}" class="texbox_normal" type="text"/></div><br/>
	Name: <input id="mi_name_${mid}" class="texbox_normal" type="text"/> Description: <input id="mi_description_${mid}" class="mi_description texbox_very_long" type="text"/><br/>
	Price: <input id="mi_price_${mid}" class="texbox_normal" type="text"/> Votes: <input id="mi_votes_${mid}" class="texbox_normal" type="text"/>
	<a onclick="delete_menu_item('mi_${mid}');" style="float:right; font-size:10px; color: #c00; margin-top: 20px;">Remove</a>
</div>
</script>
<style>
    #our_story_div {
	float: right;
    }
    #restaurant_our_story {
	height: 100px;
    }

    h3 { 
	margin-bottom: 5px;
	font-size: 24px;
    }
    #general_info_div {
	height: 160px;
    }
    .special_div {
	border: solid 1px #CCC;
	padding-left: 10px;
	padding-right: 10px;
	padding-top: 5px;
	padding-bottom: 5px;
	margin-bottom: 5px;
    }

    .texbox_normal {
	height: 20px;
	width: 200px;
    }
    .texbox_long {
	height: 20px;
	width: 300px;
    }
    .texbox_very_long {
	height: 20px;
	width: 500px;
    }
</style>
<div id="new_restaurant" class="hidden">
    You don't seem to have a restaurant setup for this id yet.  Would you like to create one? <a href="#" onclick="create_restaurant('{{ restaurant_id }}');">Create Restaurant App</a>
</div>
<div id="restaurant" class="hidden">
    {{ restuarant_id }}
    <h3>General Information</h3>
    <div id="general_info_div">
<div id="our_story_div">
    Our Story:<br/>
    <textarea id="restaurant_our_story"></textarea><br/>
</div>
<br/>
    Announcement #1: <input id="restaurant_announcement_0" class="texbox_long" type="text"/><br/>
    Announcement #2: <input id="restaurant_announcement_1" class="texbox_long" type="text"/><br/>
    Map Link: <input id="restaurant_map_link" class="texbox_long" type="text"/><br/>
</div>
<h3>Specials</h3><br/> 
    <div class="special_div">Header: <input id="special_header_0" class="texbox_normal" type="text"/> Text: <input id="special_text_0" class="texbox_very_long" type="text"/></div>
    <div class="special_div">Header: <input id="special_header_1" class="texbox_normal" type="text"/> Text: <input id="special_text_1" class="texbox_very_long" type="text"/></div>
    <div class="special_div">Header: <input id="special_header_2" class="texbox_normal" type="text"/> Text: <input id="special_text_2" class="texbox_very_long" type="text"/></div>
    <br/>
    <h3>Menu Item</h3><br/>  
    <div id="menu_items">
    </div>
    <div class="special_div" style="text-align:center">
	<a id="add_another_item_button">Add another item</a>
    </div>

        <input id="restaurant_save" type="submit" value="Save">
</div>
<script>
    var current_restaurant = null;
    var highest_menu_items = 0;

    create_restaurant = function(id) {
	var data = { "restaurant":{"name": id}};
	$.ajax({
	    type: "POST",
	    contentType: 'application/json',
	    url:'http://localhost:8083/rest/restaurant',
	    data: JSON.stringify(data),
	    success: function(result) {
		current_restaurant = data;
		current_restaurant.key = result;
		$('#new_restaurant').toggleClass('hidden');
		load_restaurant(current_restaurant);
	    }
	});
    }

    load_restaurant = function() {
	 $('#restaurant_announcement_0').val(current_restaurant.announcement_0);
	 $('#restaurant_announcement_1').val(current_restaurant.announcement_1);
	 $('#restaurant_map_link').val(current_restaurant.map_link);
	 $('#restaurant_our_story').val(current_restaurant.our_story);
	 $('#restaurant').toggleClass('hidden');
	 var length = size(current_restaurant.specials_name.item);
	 for( var i = 0 ; i < length; i++ )
	 {
	    vs('#special_header_'+i,current_restaurant.specials_name,i);
	    vs('#special_text_'+i,current_restaurant.specials_text,i);
	 }
	
	 var length = size(current_restaurant.menuitem_id.item);
	 highest_menu_items = length;
	 for( var i = 0 ; i < length; i++ )
	 {
	     var clientData = [
		{ mid: i },
	     ];
	     $("#clientTemplate").tmpl(clientData).appendTo( "#menu_items" );
	    vs('#mi_p0_'+i,current_restaurant.menuitem_parent_0,i);
	    vs('#mi_p1_'+i,current_restaurant.menuitem_parent_1,i);
	    vs('#mi_id_'+i,current_restaurant.menuitem_id,i);
	    vs('#mi_name_'+i,current_restaurant.menuitem_name,i);
	    vs('#mi_description_'+i,current_restaurant.menuitem_description,i);
	    vs('#mi_votes_'+i,current_restaurant.menuitem_votes,i);
	    vs('#mi_price_'+i,current_restaurant.menuitem_price,i);
	 }

    }

    size = function(a) {
	if (a.constructor.toString().indexOf("Array") == -1) {
	    return 1;
	}
	return a.length;
    }

    vs = function(id,vals,i) {
	if (vals.item.constructor.toString().indexOf("Array") == -1) {
	    var s = vals.item.toString();
	    if( s != "[object Object]" ) {
		$(id).val(s);
	    }
	}
	else {
	    var s = vals.item[i].toString();
	    if( s != "[object Object]" ) {
		$(id).val(s);
	    }
	}
    }

    v = function(id) {
	return $(id).val();
    }

    save_restaurant = function() {
	current_restaurant.announcement_0 = $('#restaurant_announcement_0').val();
	current_restaurant.announcement_1 = $('#restaurant_announcement_1').val();
	current_restaurant.map_link = $('#restaurant_map_link').val();
	current_restaurant.our_story = $('#restaurant_our_story').val();
	current_restaurant.specials_name = {'item':[v('#special_header_0'),v('#special_header_1'),v('#special_header_2')]};
	current_restaurant.specials_text = {'item':[v('#special_text_0'),v('#special_text_1'),v('#special_text_2')]};

	current_restaurant.menuitem_parent_0 = {'item':[]};
	current_restaurant.menuitem_parent_1 = {'item':[]};
	current_restaurant.menuitem_id = {'item':[]};
	current_restaurant.menuitem_name = {'item':[]};
	current_restaurant.menuitem_description = {'item':[]};
	current_restaurant.menuitem_votes = {'item':[]};
	current_restaurant.menuitem_price = {'item':[]};
	for( var i = 0; i < highest_menu_items; i++ ) {
	    if ($('#mi_'+i).length>0) {
		current_restaurant.menuitem_parent_0.item.push(v('#mi_p0_'+i));
		current_restaurant.menuitem_parent_1.item.push(v('#mi_p1_'+i));
		current_restaurant.menuitem_id.item.push(v('#mi_id_'+i));
		current_restaurant.menuitem_name.item.push(v('#mi_name_'+i));
		current_restaurant.menuitem_description.item.push(v('#mi_description_'+i));
		current_restaurant.menuitem_votes.item.push(v('#mi_votes_'+i));
		current_restaurant.menuitem_price.item.push(v('#mi_price_'+i));
	    }
	}

	var data = {'list': { 'restaurant': current_restaurant }};
	$.ajax({
	    type: "PUT",
	    contentType: 'application/json',
	    url:'http://localhost:8083/rest/restaurant',
	    data: JSON.stringify(data),
	    success: function(result) {
		alert('updated');
	    },
	    error: function(result) {
		alert('er');
	    }
	});

    }

    start = function() {
	$('#restaurant_save').click(save_restaurant);
	$.getJSON('http://localhost:8083/rest/restaurant?feq_name={{ restaurant_id }}',
	function(data) { 
	    if( data.list.restaurant ) {
		current_restaurant = data.list.restaurant;
		load_restaurant();
	    }
	    else {
		$('#new_restaurant').toggleClass('hidden');
	    }
	}
	);
    }

    delete_menu_item = function(id) {
	$('#'+id).remove();
    }


    $('#add_another_item_button').click( function() {
	var clientData = [
	{ mid: highest_menu_items },
	];
	$("#clientTemplate").tmpl(clientData).appendTo( "#menu_items" );
	highest_menu_items++;
    });
    $(document).ready(start);

</script>
{% endblock %}
